name: Update Release Branches

on:
  pull_request:
    types: [closed]
    branches:
      - master
      - main

jobs:
  update-release-branches:
    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get all release branches with open PRs
        id: get-prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          # Get all open and draft PRs
          echo "Fetching all open and draft pull requests..."
          
          # Get branches with PRs targeting master/main
          prs_to_master=$(gh pr list --state all --json number,headRefName,baseRefName,isDraft,state --jq ".[] | select(.state == \"OPEN\" or .isDraft == true) | select(.baseRefName == \"$BASE_BRANCH\") | .headRefName")
          
          # Get base branches (release branches) that have PRs targeting them
          release_branches_with_prs=$(gh pr list --state all --json number,headRefName,baseRefName,isDraft,state --jq ".[] | select(.state == \"OPEN\" or .isDraft == true) | select(.baseRefName | test(\"^release[/-]\") or test(\"^[0-9]+\\.[0-9]+(\\.[0-9]+)?$\")) | .baseRefName")
          
          # Combine both lists and remove duplicates
          all_branches=$(echo -e "$prs_to_master\n$release_branches_with_prs" | sort -u | grep -v '^$')

          if [ -z "$all_branches" ]; then
            echo "No release branches with open or draft PRs found"
            echo "branches=" >> $GITHUB_OUTPUT
          else
            echo "Found release branches to update:"
            echo "$all_branches"
            # Convert to comma-separated list
            branches=$(echo "$all_branches" | tr '\n' ',' | sed 's/,$//')
            echo "branches=$branches" >> $GITHUB_OUTPUT
          fi

      - name: Update release branches with master
        if: steps.get-prs.outputs.branches != ''
        env:
          BRANCHES: ${{ steps.get-prs.outputs.branches }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Split branches by comma
          IFS=',' read -ra BRANCH_ARRAY <<< "$BRANCHES"

          echo "Updating release branches with $BASE_BRANCH..."

          for branch in "${BRANCH_ARRAY[@]}"; do
            # Skip if branch is the base branch itself
            if [ "$branch" = "$BASE_BRANCH" ]; then
              echo "Skipping $branch (base branch)"
              continue
            fi

            # Check if branch matches release branch pattern (common patterns: release/*, release-*)
            if [[ "$branch" =~ ^release[/-] ]] || [[ "$branch" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
              echo "Processing release branch: $branch"

              # Fetch and checkout the branch
              if git fetch origin "$branch" && git checkout "$branch"; then
                echo "Checked out $branch"

                # Try to merge master into the branch
                if git merge "origin/$BASE_BRANCH" --no-edit; then
                  echo "Successfully merged $BASE_BRANCH into $branch"

                  # Push the changes
                  if git push origin "$branch"; then
                    echo "Successfully pushed updates to $branch"
                  else
                    echo "Failed to push updates to $branch"
                  fi
                else
                  echo "Merge conflict detected in $branch - manual resolution required"
                  echo "Branch $branch requires manual merge resolution" >> $GITHUB_STEP_SUMMARY
                fi
              else
                echo "Failed to checkout branch $branch"
              fi
            else
              echo "Skipping non-release branch: $branch"
            fi
          done

      - name: Check for conflicting PRs and notify authors
        if: steps.get-prs.outputs.branches != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCHES: ${{ steps.get-prs.outputs.branches }}
        run: |
          # Split branches by comma
          IFS=',' read -ra BRANCH_ARRAY <<< "$BRANCHES"

          echo "Checking for PRs with merge conflicts..."

          for branch in "${BRANCH_ARRAY[@]}"; do
            # Check if branch matches release branch pattern
            if [[ "$branch" =~ ^release[/-] ]] || [[ "$branch" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
              # Get all open PRs targeting this release branch
              prs=$(gh pr list --base "$branch" --state open --json number,author,headRefName,mergeable)
              
              # Check each PR for conflicts
              echo "$prs" | jq -c '.[]' | while read -r pr; do
                pr_number=$(echo "$pr" | jq -r '.number')
                pr_author=$(echo "$pr" | jq -r '.author.login')
                pr_branch=$(echo "$pr" | jq -r '.headRefName')
                mergeable=$(echo "$pr" | jq -r '.mergeable')
                
                if [ "$mergeable" = "CONFLICTING" ]; then
                  echo "âš ï¸ PR #$pr_number ($pr_branch â†’ $branch) has conflicts"
                  
                  # Check if we've already notified about conflicts
                  existing_comment=$(gh pr view "$pr_number" --json comments --jq '.comments[] | select(.author.login == "github-actions[bot]" and (.body | contains("Merge Conflict Detected"))) | .id' | head -n 1)
                  
                  if [ -z "$existing_comment" ]; then
                    # Comment on the PR using printf to handle special characters
                    printf 'ðŸš¨ **Merge Conflict Detected**\n\nThis PR now has conflicts with the base branch `%s`.\n\nThe release branch was recently updated with changes from `main`. Please resolve the conflicts to proceed with merging.\n\n**Steps to resolve:**\n1. Pull the latest changes from `%s`\n2. Merge `%s` into your feature branch `%s`\n3. Resolve any conflicts\n4. Push the changes\n\ncc @%s' "$branch" "$branch" "$branch" "$pr_branch" "$pr_author" | gh pr comment "$pr_number" --body-file -
                    
                    echo "Notified @$pr_author about conflicts in PR #$pr_number" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "Conflict notification already exists for PR #$pr_number, skipping duplicate comment" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done

      - name: Summary
        if: always()
        run: |
          echo "## Release Branch Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "Base branch: ${{ github.event.pull_request.base.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "Merged PR: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -z "${{ steps.get-prs.outputs.branches }}" ]; then
            echo "No release branches with open PRs found to update." >> $GITHUB_STEP_SUMMARY
          else
            echo "Processed branches: ${{ steps.get-prs.outputs.branches }}" >> $GITHUB_STEP_SUMMARY
          fi